@{
    ViewData["Title"] = "ticket";
    Layout = "_LayoutHome";
}
@model tickets;
<style>


    /* Active section */
    .ticket_active {
        display: flex;
        justify-content: center;
        padding: 20px;
        width: 100%;
    }

        .ticket_active > .ticket_left {
            padding: 20px;
            width: 60%;
        }

        .ticket_active > .ticket_sidebar {
            padding: 20px;
            width: 30%;
        }
    /* Navigation */
    .ticket_nav-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }

        .ticket_nav-tabs li {
            padding: 10px 20px;
            cursor: pointer;
        }

    .ticket_active-tab {
        border-bottom: 2px solid blue;
        font-weight: bold;
        color: blue;
    }

    .ticket_choice-movie {
        width: 100%
    }
    /*tab4*/
    .ticket_card-header {
        background-color: #ff7e00;
        color: white;
        font-weight: bold;
    }

    .ticket_movie-title {
        font-weight: bold;
        border: 0;
    }

    .ticket_total {
        font-size: 1.2rem;
        font-weight: bold;
        color: #000;
    }
</style>
<body>
    <div style="display:flex; justify-content:center;">
        <ul class="ticket_nav-tabs" class="text-center ">
            <li class="ticket_active-tab" id="choose-movie">Chọn phim / Rạp / Suất</li>
            <li id="choose-seat">Chọn ghế</li>
            <li id="choose-combo">Chọn thức ăn</li>
            <li id="choose-pay">Thanh toán</li>
        </ul>

    </div>
    <div class="mx-auto p-2">


        <!-- Navigation tabs -->


        <div id="movie-selection" class=" row justify-content-evenly ticket_active ">
            <div class="ticket_left col-4">
                <h2>Chọn phim/rạp/suất</h2>
                <input type="hidden" id='tempmovieId' value="">
                <div class="ticket_selection-container">
                    <div class="ticket_location-selection">
                        <h3>Chọn vị trí</h3>
                        <select id="cityDropdown" class="form-control">
                            <option value="">-- Chọn Thành Phố --</option>
                            @if (ViewBag.Cinemas != null)
                            {
                                @foreach (var city in ViewBag.Cinemas)
                                {
                                    <option value="@city.CinemaId">@city.City</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="ticket_choice-movie">

                        <h3>Chọn phim</h3>
                        <ul id="movieDropdown" class="row justify-content-center list-unstyled">
                        </ul>
                    </div>
                    <div>
                        <h3>Chọn suất chiếu</h3>
                        <div id="dateDropdown" class="btn-group" style="display:none">
                            <input type="radio" class="btn-check" name="btnradio" id="btnradio0" autocomplete="off" checked="" value="0">
                            <label class="btn btn-outline-primary" for="btnradio0">@DateTime.Today.AddDays(0).ToString("dd/MM")</label>
                            @foreach (var i in Enumerable.Range(1, 7))
                            {
                                <input type="radio" class="btn-check" name="btnradio" id="btnradio@(i)" autocomplete="off" value="@(i)">
                                <label class="btn btn-outline-primary" for="btnradio@(i)">@DateTime.Today.AddDays(i).ToString("dd/MM")</label>
                            }
                        </div>
                        <table id="showtimeDropdown">
                        </table>
                    </div>
                </div>
            </div>

            <div class="ticket_sidebar col-4">
                <div class="movie-info card">
                    <div class="ticket_card-header text-center">
                        Thanh Toán
                    </div>
                    <div class="d-flex card-body">
                        <img width="100px" height="150px" id="myImage1" src="https://via.placeholder.com/100x150" alt="Movie Poster" class="me-3">

                        <input class="ticket_movie-title" id="myTitle1" value="" readonly />

                    </div>
                    <div id="myCinema1" class=" text-center justify-content-between ">
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between card-body">

                        <p class="ticket_total">Tổng cộng</p>
                        <p class="ticket_total">0 VNĐ</p>
                    </div>
                </div>
                <div class="ticket_action-buttons">
                    <button id="button1" class="btn btn-primary float-end " type="button" disabled onclick="window.location.href='/tickets/ViewChoiceSeat'">
                        Tiếp tục
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#cityDropdown').change(function () {
                var selectedCity = $(this).val();
                // $('#movieDropdown').prop('disabled', true).empty().append('<option value="">-- Chọn Phim --</option>');
                $('#movieDropdown').empty();
                $('#showtimeDropdown').empty();
                document.getElementById("dateDropdown").style.display = "none";
                document.getElementById("btnradio0").checked = "true";
                if (selectedCity) {
                    $.getJSON('/tickets/GetCinemasByCity', { city: selectedCity }, function (data) {
                        if (data && data.length > 0) {
                            $('#movieDropdown').prop('disabled', false);
                            $.each(data, function (index, movie) {
                                $('#movieDropdown').append(`
                                                               <li class="col-4 p-6">
                                                                                <a  href="#" class="movieLink" data-movie-id="${movie.movieId}">
                                                                    <div class="movie-item text-center p-4 border rounded shadow" style="height: 390px;">
                                                                                <img src='https://localhost:5001/img/${movie.imageUrl}' alt="${movie.title}" class="w-full h-auto mb-2">
                                                                        <h3 class="movie-item-title text-lg font-semibold">${movie.title}</h3>
                                                                        <p>Thể loại: ${movie.genre}</p>
                                                                    </div>
                                                                </a>
                                                            </li>

                                                        `);
                                $('.movieLink').off('click').on('click', function (e) {
                                    $('#dateDropdown').show();
                                    e.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>
                                    const movieId = $(this).data('movie-id'); // Lấy giá trị movieId
                                    document.getElementById("tempmovieId").value = movieId;
                                    $.getJSON('/tickets/ChoiceMovie', { id: movieId }, function (data) {
                                        $('#showtimeDropdown').prop('disabled', false);
                                        $('#dateDropdown').prop('disabled', false);
                                        $.each(data, function (index, cinema) {
                                            document.getElementById('myTitle1').value = cinema.title;
                                            document.getElementById("myImage1").src = "https://localhost:5001/img/" + cinema.imageUrl;
                                            let showtimeHTML = `

                                                            <tr>

                                                                <th>${cinema.cinemaName} (${cinema.location})</th>
                                                            </tr>
                                                            <tr>`;

                                            $.each(cinema.showtimes, function (index, showtime) {
                                                showtimeHTML += `<td><a id="choiceShowtime${showtime.showTimeId}" onclick="choiceShowtime(${showtime.showtimeId})" class="btn btn-outline-primary" >${showtime.startTime} - ${showtime.endTime}</a></td>`;
                                            });

                                            showtimeHTML += '</tr>';
                                            $('#showtimeDropdown').append(showtimeHTML);

                                        });
                                    });
                                });
                            });
                        }
                    }).fail(function () {
                        console.error("API không phản hồi hoặc lỗi xảy ra");
                    });
                }
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            const radios = document.querySelectorAll('.btn-check');

            radios.forEach(radio => {
                radio.addEventListener('change', function () {

                    if (this.checked) {
                        const movieId = document.getElementById("tempmovieId");
                        $('#showtimeDropdown').empty();
                        $.getJSON('/tickets/ChoiceMovie', { id: movieId.value, date: $(this).val() }, function (data) {
                            $.each(data, function (index, cinema) {

                                let showtimeHTML = `

                                                                    <tr>
                                                                        <th>${cinema.cinemaName} (${cinema.location})</th>
                                                                    </tr>
                                                                    <tr>`;

                                $.each(cinema.showtimes, function (index, showtime) {
                                    showtimeHTML += `<td><a  id="choiceShowtime${showtime.showTimeId}" onclick="choiceShowtime(${showtime.showtimeId})" class="btn btn-outline-primary" >${showtime.startTime} - ${showtime.endTime}</a></td>`;
                                });

                                showtimeHTML += '</tr>';
                                $('#showtimeDropdown').append(showtimeHTML);
                            });
                        });
                    }
                });
            });
        });

        function choiceShowtime(showTimeId) {
            $.getJSON('/tickets/ChoiceShowTime', { id: showTimeId }, function (data) {
                const cinema = data.cinema;
                const showtime = data.showtime;
                // Chuyển `startTime` thành đối tượng Date
                const date = new Date(showtime.startTime);

                // Định dạng thời gian
                const formattedTime = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });

                let myCinema1HTML;
                myCinema1HTML = `
                                                  <p>${cinema.name} (${cinema.location}) -${showtime.hall}</p>
                                                          <p>Thời gian: ${formattedTime} - ${formattedDate}</p>
                                                            `;

                $('#myCinema1').append(myCinema1HTML);
            });
        }
        //kiem tra nut
        document.addEventListener('DOMContentLoaded', function () {
            const myDiv = document.getElementById('myCinema1');
            const myButton = document.getElementById('button1');

            // Hàm kiểm tra số lượng phần tử con
            function toggleButtonState() {
                if (myDiv.children.length > 0) {
                    myButton.disabled = false; // Kích hoạt nút
                } else {
                    myButton.disabled = true; // Vô hiệu hóa nút
                }
            }

            // Quan sát sự thay đổi trong div
            const observer = new MutationObserver(toggleButtonState);

            observer.observe(myDiv, { childList: true });

            // Gọi hàm ngay lần đầu
            toggleButtonState();
        });


    </script>


</body>
