

@{
    ViewData["Title"] = "ticket";
    Layout = "_LayoutHome";
}
@model tickets;

<style>
    /* General styles */
    body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
    }

    .ticket_nav-tabs {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        list-style: none;
        padding: 0;
    }

    .ticket_nav-tabs li {
        margin: 0 15px;
        padding: 10px 20px;
        font-size: 1.2rem;
        font-weight: bold;
        color: #555;
        cursor: pointer;
    }

    .ticket_active-tab {
        border-bottom: 3px solid #0045a0;
        color: #0045a0;
    }

    /* Movie selection */
    .ticket_active {
        display: flex;
        justify-content: space-between;
        padding: 20px;
    }

    .ticket_left {
        width: 65%;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ticket_left h3 {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }

    .ticket_sidebar {
        width: 30%;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .ticket_sidebar .ticket_card-header {
        background-color: #ff7e00;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        padding: 10px 0;
    }

    .ticket_sidebar img {
        max-width: 100%;
        border-radius: 8px;
    }

    .ticket_total {
        font-size: 1rem;
        font-weight: bold;
        color: #333;
    }

    /* Movie grid */
    #movieDropdown {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .movie-item {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
    }

    .movie-item:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .movie-item img {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .movie-item-title {
        font-size: 1rem;
        font-weight: bold;
        color: #333;
    }
</style>

<body>
    <div>
        <ul class="ticket_nav-tabs">
            <li class="ticket_active-tab" id="choose-movie">Chọn phim / Rạp / Suất</li>
            <li id="choose-seat">Chọn ghế</li>
            <li id="choose-combo">Chọn thức ăn</li>
            <li id="choose-pay">Thanh toán</li>
        </ul>
    </div>

    <div class="ticket_active container">
        <!-- Left Section -->
        <div class="ticket_left">
            <h3>Chọn Vị Trí</h3>
            <select id="cityDropdown" class="form-control mb-3">
                <option value="">-- Chọn Thành Phố --</option>
                @if (ViewBag.Cinemas != null)
                {
                    @foreach (var city in ViewBag.Cinemas)
                    {
                        <option value="@city.CinemaId">@city.City</option>
                    }
                }
            </select>

            <h3>Chọn Phim</h3>
            <ul id="movieDropdown" class="row justify-content-start list-unstyled"></ul>

            <h3>Chọn Suất Chiếu</h3>
            <div id="dateDropdown" class="btn-group mb-3" style="display: none;"></div>
            <table id="showtimeDropdown" class="table"></table>
        </div>

        <!-- Right Sidebar -->
        <div class="ticket_sidebar">
            <div class="movie-info card">
                <div class="ticket_card-header">Thông Tin Phim</div>
                <div class="card-body">
                    <img id="myImage1" src="https://via.placeholder.com/100x150" alt="Movie Poster" class="mb-3">
                    <div id="myCinema1"></div>
                </div>
                <hr>
                <div class="d-flex justify-content-between px-3">
                    <span class="ticket_total">Tổng cộng</span>
                    <span class="ticket_total">0 VNĐ</span>
                </div>
                <button id="button1" class="btn btn-primary w-100 mt-3" disabled>Tiếp Tục</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#cityDropdown').change(function () {
                var selectedCity = $(this).val();
                // $('#movieDropdown').prop('disabled', true).empty().append('<option value="">-- Chọn Phim --</option>');
                $('#movieDropdown').empty();
                $('#showtimeDropdown').empty();
                document.getElementById("dateDropdown").style.display = "none";
                document.getElementById("btnradio0").checked = "true";
                if (selectedCity) {
                    $.getJSON('/tickets/GetCinemasByCity', { city: selectedCity }, function (data) {
                        if (data && data.length > 0) {
                            $('#movieDropdown').prop('disabled', false);
                            $.each(data, function (index, movie) {
                                $('#movieDropdown').append(`
                                                                               <li class="col-4 p-6">
                                                                                                <a  href="#" class="movieLink" data-movie-id="${movie.movieId}">
                                                                                    <div class="movie-item text-center p-4 border rounded shadow" style="height: 390px;">
                                                                                                <img src='https://localhost:5001/${movie.imageUrl}' alt="${movie.title}" class="w-full h-auto mb-2">
                                                                                        <h3 class="movie-item-title text-lg font-semibold">${movie.title}</h3>
                                                                                        <p>Thể loại: ${movie.genre}</p>
                                                                                    </div>
                                                                                </a>
                                                                            </li>

                                                                        `);
                                $('.movieLink').off('click').on('click', function (e) {
                                    $('#dateDropdown').show();
                                    e.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>
                                    const movieId = $(this).data('movie-id'); // Lấy giá trị movieId
                                    document.getElementById("tempmovieId").value = movieId;
                                    $.getJSON('/tickets/ChoiceMovie', { id: movieId }, function (data) {
                                        $('#showtimeDropdown').prop('disabled', false);
                                        $('#dateDropdown').prop('disabled', false);
                                        $.each(data, function (index, cinema) {
                                            document.getElementById('myTitle1').value = cinema.title;
                                            document.getElementById("myImage1").src = "https://localhost:5001/img/" + cinema.imageUrl;
                                            let showtimeHTML = `

                                                                            <tr>

                                                                                <th>${cinema.cinemaName} (${cinema.location})</th>
                                                                            </tr>
                                                                            <tr>`;

                                            $.each(cinema.showtimes, function (index, showtime) {
                                                showtimeHTML += `<td><a id="choiceShowtime${showtime.showTimeId}" onclick="choiceShowtime(${showtime.showtimeId})" class="btn btn-outline-primary" >${showtime.startTime} - ${showtime.endTime}</a></td>`;
                                            });

                                            showtimeHTML += '</tr>';
                                            $('#showtimeDropdown').append(showtimeHTML);

                                        });
                                    });
                                });
                            });
                        }
                    }).fail(function () {
                        console.error("API không phản hồi hoặc lỗi xảy ra");
                    });
                }
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            const radios = document.querySelectorAll('.btn-check');

            radios.forEach(radio => {
                radio.addEventListener('change', function () {

                    if (this.checked) {
                        const movieId = document.getElementById("tempmovieId");
                        $('#showtimeDropdown').empty();
                        $.getJSON('/tickets/ChoiceMovie', { id: movieId.value, date: $(this).val() }, function (data) {
                            $.each(data, function (index, cinema) {

                                let showtimeHTML = `

                                                                                    <tr>
                                                                                        <th>${cinema.cinemaName} (${cinema.location})</th>
                                                                                    </tr>
                                                                                    <tr>`;

                                $.each(cinema.showtimes, function (index, showtime) {
                                    showtimeHTML += `<td><a  id="choiceShowtime${showtime.showTimeId}" onclick="choiceShowtime(${showtime.showtimeId})" class="btn btn-outline-primary" >${showtime.startTime} - ${showtime.endTime}</a></td>`;
                                });

                                showtimeHTML += '</tr>';
                                $('#showtimeDropdown').append(showtimeHTML);
                            });
                        });
                    }
                });
            });
        });

        function choiceShowtime(showTimeId) {
            $.getJSON('/tickets/ChoiceShowTime', { id: showTimeId }, function (data) {
                const cinema = data.cinema;
                const showtime = data.showtime;
                // Chuyển `startTime` thành đối tượng Date
                const date = new Date(showtime.startTime);

                // Định dạng thời gian
                const formattedTime = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });

                let myCinema1HTML;
                myCinema1HTML = `
                                                                  <p>${cinema.name} (${cinema.location}) -${showtime.hall}</p>
                                                                          <p>Thời gian: ${formattedTime} - ${formattedDate}</p>
                                                                            `;

                $('#myCinema1').append(myCinema1HTML);
            });
        }
        //kiem tra nut
        document.addEventListener('DOMContentLoaded', function () {
            const myDiv = document.getElementById('myCinema1');
            const myButton = document.getElementById('button1');

            // Hàm kiểm tra số lượng phần tử con
            function toggleButtonState() {
                if (myDiv.children.length > 0) {
                    myButton.disabled = false; // Kích hoạt nút
                } else {
                    myButton.disabled = true; // Vô hiệu hóa nút
                }
            }

            // Quan sát sự thay đổi trong div
            const observer = new MutationObserver(toggleButtonState);

            observer.observe(myDiv, { childList: true });

            // Gọi hàm ngay lần đầu
            toggleButtonState();
        });


    </script>


</body>
